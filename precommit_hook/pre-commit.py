#!/usr/bin/env python

# Unless it's *absolutely* necessary, prefer making changes to tool.py, instead of this file.

import argparse
import sys
import subprocess

import os,inspect
currentdir = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe())))
parentdir = os.path.dirname(currentdir)
grandparentdir = os.path.dirname(parentdir)
sys.path.insert(0,grandparentdir) 

from vulnerability_tool.tool import run_tool

GIT_COMMAND = "git diff-index -z --cached HEAD --name-only"

def is_file(string):
    return string.find(".") != -1

def fetch_commited_files():
    command = GIT_COMMAND.split()
    popen = subprocess.Popen(['git', 'diff', '--cached', '--name-status'], stdout=subprocess.PIPE)
    out, err = popen.communicate()
    if err:
        print("There was an error in getting the commited files: %s", err)

    out = out.decode('utf-8')
    files = list(filter(is_file, out.split()))
    return files

# For language/libary detection.
def read_file(file_path):
    content = ""
    with open(file_path, "r") as file:
        content = file.read().split("\n")
    return content

def main():
    files = fetch_commited_files()
    passing = True
    for file in files:
        file_contents = read_file(file)
        passing = run_tool(file, file_contents) and passing
    return 0 if passing else 1

if __name__ == '__main__':
    sys.exit(main())
